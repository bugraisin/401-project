<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <tit        function handleAccidentUpdate(data) {
            console.log('Received data:', data);
            
            // Create marker at the accident location
            const marker = L.circleMarker([data.location.lat, data.location.lng], {teractive Demo: Real-Time Accident Prediction</title>
    
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrolling */
        }
        #map {
            height: 100vh;
        }
        /* Custom scrollbar for the log panel */
        .log-panel::-webkit-scrollbar {
            width: 6px;
        }
        .log-panel::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .log-panel::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        .log-panel::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Leaflet popup customization */
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="flex h-screen">
        <!-- Control and Log Panel -->
        <div class="w-full md:w-1/3 lg:w-1/4 h-screen bg-white shadow-lg flex flex-col p-4 z-10">
            <div class="flex-shrink-0 pb-4 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-gray-800">Accident Prediction</h1>
                <p class="text-sm text-gray-500">Live Simulation</p>
            </div>
            
            <!-- Controls -->
            <div class="flex-shrink-0 py-4">
                <button id="toggle-stream-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-all duration-200">
                    Start Simulation
                </button>
            </div>

            <!-- Legend -->
            <div class="flex-shrink-0 py-4 border-t border-b border-gray-200">
                 <h2 class="text-lg font-semibold text-gray-700 mb-2">Severity Legend</h2>
                 <ul class="space-y-2 text-sm">
                    <li class="flex items-center"><span class="h-4 w-4 rounded-full bg-green-500 mr-3 border border-gray-400"></span>Minor (1)</li>
                    <li class="flex items-center"><span class="h-4 w-4 rounded-full bg-yellow-400 mr-3 border border-gray-400"></span>Moderate (2)</li>
                    <li class="flex items-center"><span class="h-4 w-4 rounded-full bg-orange-500 mr-3 border border-gray-400"></span>Severe (3)</li>
                    <li class="flex items-center"><span class="h-4 w-4 rounded-full bg-red-600 mr-3 border border-gray-400"></span>Fatal (4)</li>
                    <li class="flex items-center"><span class="h-4 w-4 rounded-full bg-gray-400 mr-3 border border-gray-400"></span>Processing...</li>
                 </ul>
            </div>

            <!-- Log Panel -->
            <div class="flex-grow overflow-y-auto log-panel pt-4">
                <h2 class="text-lg font-semibold text-gray-700 mb-2">Event Log</h2>
                <div id="log-container" class="space-y-2 text-xs text-gray-600">
                    <p class="text-gray-400">Simulation not started. Click the button above.</p>
                </div>
            </div>
        </div>

        <!-- Map Panel -->
        <div class="w-full md:w-2/3 lg:w-3/4 h-screen">
            <div id="map"></div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script>
        // --- Global State & Configuration ---
        let socket;
        let isSimulating = false;
        const markers = {}; // Store markers by accident ID

        const SIMULATION_SPEED_MS = 3000; // New event every 3 seconds
        const PROCESSING_DELAY_MS = 1500; // Time to "predict" severity

        // --- UI Elements ---
        const toggleBtn = document.getElementById('toggle-stream-btn');
        const logContainer = document.getElementById('log-container');

        // --- Map Initialization ---
        const map = L.map('map').setView([37.7749, -122.4194], 12); // San Francisco
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);

        // --- Severity & Marker Configuration ---
        const severityConfig = {
            1: { color: '#22c55e', name: 'Minor' },    // green-500
            2: { color: '#facc15', name: 'Moderate' }, // yellow-400
            3: { color: '#f97316', name: 'Severe' },   // orange-500
            4: { color: '#dc2626', name: 'Fatal' },    // red-600
        };
        const processingColor = '#9ca3af'; // gray-400

        // --- Helper Functions ---
        function logMessage(message, color = 'text-gray-600') {
            const p = document.createElement('p');
            const time = new Date().toLocaleTimeString();
            p.innerHTML = `<span class="font-semibold text-gray-400">${time}:</span> <span class="${color}">${message}</span>`;
            logContainer.prepend(p);
            // Clear initial message
            if (logContainer.children.length > 1 && logContainer.lastChild.textContent.includes('Simulation not started')) {
                logContainer.removeChild(logContainer.lastChild);
            }
            // Keep log from getting too long
            if (logContainer.children.length > 50) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // --- WebSocket Connection ---
        function connectWebSocket() {
            socket = io('http://localhost:3000');
            
            socket.on('connect', () => {
                logMessage('Connected to server', 'text-green-600');
            });

            socket.on('accidentUpdate', (accident) => {
                console.log('WebSocket received:', accident);
                handleAccidentUpdate(accident);
            });

            socket.on('disconnect', () => {
                logMessage('Disconnected from server', 'text-red-600');
            });
        }

        function handleAccidentUpdate(data) {
            console.log('Received accident data:', data);

            const locationKey = `${data.location.lat},${data.location.lng}`;
            let marker = markers[locationKey];

            // Create new marker if it doesn't exist
            if (!marker) {
                marker = L.circleMarker([data.location.lat, data.location.lng], {
                    radius: 8,
                    fillColor: processingColor,
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map);
                markers[locationKey] = marker;
            }
            
            // Use the actual prediction from backend
            const prediction = Math.round(data.prediction);
            const config = severityConfig[prediction];
            
            if (config) {
                logMessage(`New prediction: <b>Severity ${prediction} (${config.name})</b> at [${data.location.lat}, ${data.location.lng}]`, 'text-green-600');
                
                marker.setStyle({ fillColor: config.color });
                const popupContent = `
                    <b>Accident Prediction</b><br>
                    <hr class="my-1">
                    <b>Location:</b> [${data.location.lat}, ${data.location.lng}]<br>
                    <b>Severity:</b> <span style="font-weight:bold; color:${config.color};">${config.name} (${prediction})</span><br>
                    <b>Time:</b> ${new Date(data.timestamp * 1000).toLocaleString()}
                `;
                marker.bindPopup(popupContent).openPopup();
                setTimeout(() => marker.closePopup(), 4000);
            }
        }

        // --- Event Listener for the button ---
        toggleBtn.addEventListener('click', () => {
            isSimulating = !isSimulating;
            if (isSimulating) {
                connectWebSocket();
                toggleBtn.textContent = 'Stop Simulation';
                toggleBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                toggleBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                logMessage('Simulation started.', 'font-bold');
            } else {
                if (socket) {
                    socket.disconnect();
                }
                toggleBtn.textContent = 'Start Simulation';
                toggleBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                toggleBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                logMessage('Simulation stopped.', 'font-bold');
            }
        });

    </script>
</body>
</html>